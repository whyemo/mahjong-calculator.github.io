<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>éº»å°†è®°è´¦å·¥å…·</title>
    <style>
        /* å…¨å±€æ ·å¼ï¼Œé€‚é…iPhoneè§¦å± */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "å¾®è½¯é›…é»‘", sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            background-color: #f5f5f5;
            padding: 15px;
            min-height: 100vh;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        /* æ ‡é¢˜å’Œè®¡æ—¶æ ·å¼ */
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 20px;
        }
        .timer-section {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .timer-info {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        .timer-display {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }
        .timer-btn {
            width: auto;
            padding: 0 20px;
            height: 40px;
            line-height: 40px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            color: white;
            background-color: #07c160;
            cursor: pointer;
        }
        .timer-btn.stop {
            background-color: #f53f3f;
        }
        /* æ¨¡å—æ ·å¼ */
        .module {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .module-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .module-title small {
            font-size: 12px;
            font-weight: normal;
            color: #999;
            cursor: pointer;
        }
        /* ç©å®¶é¡¹æ ·å¼ - è¾“å…¥æ¡†å®½åº¦50% */
        .player-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        .player-input {
            width: 50%;
            height: 40px;
            line-height: 40px;
            border: 1px solid #eee;
            padding: 0 10px;
            border-radius: 6px;
            font-size: 14px;
            margin-right: 10px;
        }
        .player-total {
            font-size: 14px;
            color: #666;
            min-width: 80px;
        }
        /* é€šç”¨æŒ‰é’®æ ·å¼ */
        button {
            width: 100%;
            height: 45px;
            line-height: 45px;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            color: white;
            margin: 8px 0;
            cursor: pointer;
        }
        .btn-normal {
            background-color: #07c160;
        }
        .btn-warn {
            background-color: #f53f3f;
        }
        .btn-secondary {
            background-color: #666;
        }
        .btn-small {
            width: auto;
            height: 32px;
            line-height: 32px;
            padding: 0 8px;
            font-size: 12px;
            border-radius: 4px;
        }
        .btn-active {
            background-color: #059850 !important;
        }
        .btn-double {
            background-color: #ff9500;
            margin-left: 5px;
        }
        .btn-double.active {
            background-color: #e68900 !important;
        }
        /* è‡ªå®šä¹‰é‡‘é¢æ¨¡å— - æ ¸å¿ƒä¼˜åŒ–æ ·å¼ */
        .custom-amount-item {
            display: flex;
            align-items: center;
            margin: 12px 0;
            gap: 8px;
        }
        .custom-name {
            width: 40%;
            font-size: 14px;
            font-weight: 500;
        }
        .amount-btn-group {
            display: flex;
            gap: 5px;
        }
        .win-btn, .lose-btn {
            width: 40px;
            height: 32px;
            line-height: 32px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            color: white;
        }
        .win-btn {
            background-color: #07c160;
        }
        .lose-btn {
            background-color: #f53f3f;
        }
        .custom-amount-input {
            flex: 1;
            height: 32px;
            line-height: 32px;
            border: 1px solid #eee;
            padding: 0 8px;
            border-radius: 4px;
            font-size: 14px;
            text-align: center;
        }
        /* è‡ªæ‘¸å¼¹çª—æ ·å¼ - æ–°å¢åŒå€æŒ‰é’® */
        .zim-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
            padding: 20px;
        }
        .zim-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 100%;
            max-width: 400px;
        }
        .zim-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }
        .zim-tip {
            font-size: 13px;
            color: #666;
            margin-bottom: 15px;
            padding: 8px;
            background-color: #f8f8f8;
            border-radius: 4px;
            text-align: center;
        }
        .zim-player-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            border: 1px solid #eee;
            border-radius: 6px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        .zim-player-item.active {
            background-color: #07c160;
            color: white;
            border-color: #07c160;
        }
        .zim-amount-input {
            width: 100%;
            height: 40px;
            line-height: 40px;
            border: 1px solid #eee;
            padding: 0 10px;
            border-radius: 6px;
            margin: 15px 0;
            text-align: center;
            font-size: 16px;
        }
        .zim-player-name {
            font-size: 14px;
            font-weight: 500;
        }
        /* å†å²è®°å½•è¡¨æ ¼æ ·å¼ - æ ¸å¿ƒä¼˜åŒ– */
        .history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            margin-top: 10px;
        }
        .history-table th, .history-table td {
            border: 1px solid #eee;
            padding: 8px 5px;
            text-align: center;
        }
        .history-table th {
            background-color: #f8f8f8;
            font-weight: 500;
            color: #333;
        }
        .history-table .win-num {
            color: #07c160;
            font-weight: 500;
        }
        .history-table .lose-num {
            color: #f53f3f;
            font-weight: 500;
        }
        .history-table .zero-num {
            color: #999;
        }
        .history-empty {
            text-align: center;
            color: #999;
            padding: 30px 0;
            font-size: 14px;
        }
        /* ç»“ç®—æ¸…å•æ ·å¼ */
        .settle-item {
            font-size: 15px;
            line-height: 40px;
            border-bottom: 1px solid #eee;
            color: #333;
        }
        .empty-tip {
            text-align: center;
            color: #999;
            padding: 20px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>éº»å°†è®°è´¦å·¥å…·</h1>
        
        <!-- è®¡æ—¶æ¨¡å— -->
        <div class="timer-section">
            <div class="timer-info" id="startTime">å¼€å§‹æ—¶é—´ï¼šæœªå¼€å§‹</div>
            <div class="timer-display" id="timer">è®¡æ—¶ï¼š00:00:00</div>
            <button class="timer-btn" id="timerBtn" onclick="toggleTimer()">å¼€å§‹è®¡æ—¶</button>
        </div>

        <!-- ç©å®¶è®¾ç½®æ¨¡å—ï¼ˆè¾“å…¥æ¡†50%å®½åº¦ï¼‰ -->
        <div class="module">
            <div class="module-title">ğŸ”¹ ç©å®¶è®¾ç½®</div>
            <div class="player-item">
                <input type="text" class="player-input" id="player1" value="A" placeholder="ç©å®¶1åç§°">
                <span class="player-total" id="total1">0 å…ƒ</span>
            </div>
            <div class="player-item">
                <input type="text" class="player-input" id="player2" value="B" placeholder="ç©å®¶2åç§°">
                <span class="player-total" id="total2">0 å…ƒ</span>
            </div>
            <div class="player-item">
                <input type="text" class="player-input" id="player3" value="C" placeholder="ç©å®¶3åç§°">
                <span class="player-total" id="total3">0 å…ƒ</span>
            </div>
            <div class="player-item">
                <input type="text" class="player-input" id="player4" value="D" placeholder="ç©å®¶4åç§°">
                <span class="player-total" id="total4">0 å…ƒ</span>
            </div>
        </div>

        <!-- å¿«æ·è®°å½•æ¨¡å— -->
        <div class="module">
            <div class="module-title">ğŸ”¹ å¿«æ·è®°å½•</div>
            <button class="btn-normal" onclick="showZimModal()">è‡ªæ‘¸</button>
            <button class="btn-secondary" onclick="showCustomInput()">è‡ªå®šä¹‰æœ¬å±€é‡‘é¢</button>
            <button class="btn-warn" onclick="clearAll()">æ¸…ç©ºæ‰€æœ‰è®°å½•</button>
        </div>

        <!-- è‡ªå®šä¹‰é‡‘é¢æ¨¡å— - æ ¸å¿ƒä¼˜åŒ– -->
        <div class="module" id="customModule" style="display: none;">
            <div class="module-title">ğŸ”¹ è‡ªå®šä¹‰æœ¬å±€é‡‘é¢</div>
            <!-- ç©å®¶1 -->
            <div class="custom-amount-item">
                <span class="custom-name" id="customName1">A</span>
                <div class="amount-btn-group">
                    <button class="win-btn" onclick="setAmountType(1, 'win')">èµ¢</button>
                    <button class="lose-btn" onclick="setAmountType(1, 'lose')">è¾“</button>
                </div>
                <input type="number" class="custom-amount-input" id="custom1" placeholder="é‡‘é¢" value="" data-type="none">
            </div>
            <!-- ç©å®¶2 -->
            <div class="custom-amount-item">
                <span class="custom-name" id="customName2">B</span>
                <div class="amount-btn-group">
                    <button class="win-btn" onclick="setAmountType(2, 'win')">èµ¢</button>
                    <button class="lose-btn" onclick="setAmountType(2, 'lose')">è¾“</button>
                </div>
                <input type="number" class="custom-amount-input" id="custom2" placeholder="é‡‘é¢" value="" data-type="none">
            </div>
            <!-- ç©å®¶3 -->
            <div class="custom-amount-item">
                <span class="custom-name" id="customName3">C</span>
                <div class="amount-btn-group">
                    <button class="win-btn" onclick="setAmountType(3, 'win')">èµ¢</button>
                    <button class="lose-btn" onclick="setAmountType(3, 'lose')">è¾“</button>
                </div>
                <input type="number" class="custom-amount-input" id="custom3" placeholder="é‡‘é¢" value="" data-type="none">
            </div>
            <!-- ç©å®¶4 -->
            <div class="custom-amount-item">
                <span class="custom-name" id="customName4">D</span>
                <div class="amount-btn-group">
                    <button class="win-btn" onclick="setAmountType(4, 'win')">èµ¢</button>
                    <button class="lose-btn" onclick="setAmountType(4, 'lose')">è¾“</button>
                </div>
                <input type="number" class="custom-amount-input" id="custom4" placeholder="é‡‘é¢" value="" data-type="none">
            </div>
            <button class="btn-normal" onclick="addCustomRound()">ç¡®è®¤è®°å½•</button>
            <button class="btn-secondary" onclick="clearCustomAmount()">æ¸…ç©ºæœ¬å±€é‡‘é¢</button>
            <button class="btn-secondary" onclick="hideCustomInput()">å–æ¶ˆ</button>
        </div>

        <!-- è‡ªæ‘¸å¼¹çª— - æ ¸å¿ƒä¼˜åŒ–ï¼šåŒå€æŒ‰é’®+é‡‘é¢æç¤º -->
        <div class="zim-modal" id="zimModal" style="display: none;">
            <div class="zim-content">
                <div class="zim-title">é€‰æ‹©è‡ªæ‘¸ç©å®¶</div>
                <div class="zim-tip">è¯·é€‰æ‹©è‡ªæ‘¸ç©å®¶ï¼Œå…¶ä»–ç©å®¶å¯è®¾ç½®åŒå€æ”¯ä»˜ï¼ˆå¦‚åƒä¸‰å£ï¼‰</div>
                <!-- è‡ªæ‘¸ç©å®¶é€‰æ‹© -->
                <div class="zim-player-item" id="zimPlayer1" onclick="selectZimPlayer(1)">
                    <span class="zim-player-name">A</span>
                    <span>âœ“ è‡ªæ‘¸</span>
                </div>
                <div class="zim-player-item" id="zimPlayer2" onclick="selectZimPlayer(2)">
                    <span class="zim-player-name">B</span>
                    <span>âœ“ è‡ªæ‘¸</span>
                </div>
                <div class="zim-player-item" id="zimPlayer3" onclick="selectZimPlayer(3)">
                    <span class="zim-player-name">C</span>
                    <span>âœ“ è‡ªæ‘¸</span>
                </div>
                <div class="zim-player-item" id="zimPlayer4" onclick="selectZimPlayer(4)">
                    <span class="zim-player-name">D</span>
                    <span>âœ“ è‡ªæ‘¸</span>
                </div>
                <!-- é‡‘é¢è¾“å…¥æç¤ºä¿®æ”¹ -->
                <input type="number" class="zim-amount-input" id="zimAmount" placeholder="è¯·è¾“å…¥æ¯ä½ç©å®¶è¾“çš„åŸºç¡€é‡‘é¢" value="10">
                <!-- éè‡ªæ‘¸ç©å®¶åŒå€è®¾ç½® -->
                <div id="zimDoubleContainer" style="display: none;">
                    <div class="zim-tip" style="margin-top: 0;">éè‡ªæ‘¸ç©å®¶åŒå€æ”¯ä»˜è®¾ç½®</div>
                    <div class="zim-player-item" id="zimDouble1" onclick="toggleZimDouble(1)">
                        <span class="zim-player-name">A</span>
                        <button class="btn-small btn-double" id="doubleBtn1">æ˜¯å¦åŒå€</button>
                    </div>
                    <div class="zim-player-item" id="zimDouble2" onclick="toggleZimDouble(2)">
                        <span class="zim-player-name">B</span>
                        <button class="btn-small btn-double" id="doubleBtn2">æ˜¯å¦åŒå€</button>
                    </div>
                    <div class="zim-player-item" id="zimDouble3" onclick="toggleZimDouble(3)">
                        <span class="zim-player-name">C</span>
                        <button class="btn-small btn-double" id="doubleBtn3">æ˜¯å¦åŒå€</button>
                    </div>
                    <div class="zim-player-item" id="zimDouble4" onclick="toggleZimDouble(4)">
                        <span class="zim-player-name">D</span>
                        <button class="btn-small btn-double" id="doubleBtn4">æ˜¯å¦åŒå€</button>
                    </div>
                </div>
                <button class="btn-normal" onclick="confirmZim()">ç¡®è®¤è®°å½•</button>
                <button class="btn-secondary" onclick="hideZimModal()">å–æ¶ˆ</button>
            </div>
        </div>

        <!-- å†å²è®°å½•æ¨¡å— - æ ¸å¿ƒä¼˜åŒ–ï¼šè¡¨æ ¼å½¢å¼ -->
        <div class="module">
            <div class="module-title">
                ğŸ”¹ æ¯å±€å†å²è®°å½•
                <small onclick="clearHistory()">æ¸…ç©ºå†å²</small>
            </div>
            <div id="historyList">
                <div class="history-empty">æš‚æ— å¯¹å±€è®°å½•ï½</div>
            </div>
        </div>

        <!-- ç»“ç®—æ¸…å•æ¨¡å— -->
        <div class="module">
            <div class="module-title">ğŸ”¹ æœ€ç»ˆç»“ç®—æ¸…å•</div>
            <div id="settleList">
                <div class="empty-tip">æš‚æ— è®°å½•ï¼Œå…ˆæ·»åŠ å¯¹å±€ç»“æœå§ï½</div>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–å…¨å±€æ•°æ®
        let players = JSON.parse(localStorage.getItem('mahjongPlayers')) || [
            { id: 1, name: 'A', total: 0 },
            { id: 2, name: 'B', total: 0 },
            { id: 3, name: 'C', total: 0 },
            { id: 4, name: 'D', total: 0 }
        ];
        let historyRecords = JSON.parse(localStorage.getItem('mahjongHistory')) || [];
        // è®¡æ—¶ç›¸å…³
        let timerInterval = null;
        let startTime = null;
        let isTiming = false;
        let elapsedSeconds = 0;
        // è‡ªæ‘¸ç›¸å…³ - æ–°å¢åŒå€æ”¯ä»˜æ ‡è®°
        let selectedZimPlayerId = null;
        let zimDoubleMap = { 1: false, 2: false, 3: false, 4: false };
        // è‡ªå®šä¹‰é‡‘é¢ç›¸å…³ - æ–°å¢ç±»å‹æ ‡è®°ï¼ˆwin/lose/noneï¼‰

        // é¡µé¢åŠ è½½åˆå§‹åŒ–
        window.onload = function() {
            updatePlayerDisplay();
            calcSettleList();
            updateHistoryDisplay();
            // ç›‘å¬ç©å®¶åç§°ä¿®æ”¹
            document.getElementById('player1').addEventListener('input', updatePlayerName);
            document.getElementById('player2').addEventListener('input', updatePlayerName);
            document.getElementById('player3').addEventListener('input', updatePlayerName);
            document.getElementById('player4').addEventListener('input', updatePlayerName);
            // æ¢å¤è®¡æ—¶çŠ¶æ€
            const timerData = JSON.parse(localStorage.getItem('mahjongTimer'));
            if (timerData && timerData.isTiming) {
                startTime = new Date(timerData.startTime);
                isTiming = true;
                elapsedSeconds = timerData.elapsedSeconds;
                document.getElementById('startTime').textContent = `å¼€å§‹æ—¶é—´ï¼š${formatTime(startTime)}`;
                document.getElementById('timerBtn').textContent = 'ç»“æŸè®¡æ—¶';
                document.getElementById('timerBtn').classList.add('stop');
                startTimerInterval();
                updateTimerDisplay();
            }
        };

        // å·¥å…·å‡½æ•°ï¼šæ ¼å¼åŒ–æ—¶é—´ï¼ˆå¹´æœˆæ—¥ æ—¶åˆ†ç§’ï¼‰
        function formatTime(date) {
            if (!date) return 'æœªå¼€å§‹';
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const hour = date.getHours().toString().padStart(2, '0');
            const minute = date.getMinutes().toString().padStart(2, '0');
            const second = date.getSeconds().toString().padStart(2, '0');
            return `${year}-${month}-${day} ${hour}:${minute}:${second}`;
        }

        // å·¥å…·å‡½æ•°ï¼šæ ¼å¼åŒ–è®¡æ—¶ï¼ˆHH:MM:SSï¼‰
        function formatElapsedTime(seconds) {
            const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        }

        // è®¡æ—¶åŠŸèƒ½ï¼šå¼€å§‹/åœæ­¢
        function toggleTimer() {
            if (!isTiming) {
                startTime = new Date();
                isTiming = true;
                elapsedSeconds = 0;
                document.getElementById('startTime').textContent = `å¼€å§‹æ—¶é—´ï¼š${formatTime(startTime)}`;
                document.getElementById('timerBtn').textContent = 'ç»“æŸè®¡æ—¶';
                document.getElementById('timerBtn').classList.add('stop');
                startTimerInterval();
            } else {
                clearInterval(timerInterval);
                isTiming = false;
                document.getElementById('timerBtn').textContent = 'å¼€å§‹è®¡æ—¶';
                document.getElementById('timerBtn').classList.remove('stop');
                alert(`éº»å°†å¯¹å±€ç»“æŸï¼æ€»æ—¶é•¿ï¼š${formatElapsedTime(elapsedSeconds)}`);
            }
            // ä¿å­˜è®¡æ—¶çŠ¶æ€
            localStorage.setItem('mahjongTimer', JSON.stringify({
                isTiming,
                startTime: startTime ? startTime.toISOString() : null,
                elapsedSeconds
            }));
        }
        function startTimerInterval() {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                elapsedSeconds++;
                updateTimerDisplay();
                localStorage.setItem('mahjongTimer', JSON.stringify({
                    isTiming,
                    startTime: startTime ? startTime.toISOString() : null,
                    elapsedSeconds
                }));
            }, 1000);
        }
        function updateTimerDisplay() {
            document.getElementById('timer').textContent = `è®¡æ—¶ï¼š${formatElapsedTime(elapsedSeconds)}`;
        }

        // ç©å®¶åç§°æ›´æ–°ï¼šåŒæ­¥æ‰€æœ‰æ¨¡å—åç§°
        function updatePlayerName() {
            players[0].name = document.getElementById('player1').value || 'A';
            players[1].name = document.getElementById('player2').value || 'B';
            players[2].name = document.getElementById('player3').value || 'C';
            players[3].name = document.getElementById('player4').value || 'D';
            // åŒæ­¥è‡ªå®šä¹‰æ¨¡å—
            document.getElementById('customName1').textContent = players[0].name;
            document.getElementById('customName2').textContent = players[1].name;
            document.getElementById('customName3').textContent = players[2].name;
            document.getElementById('customName4').textContent = players[3].name;
            // åŒæ­¥è‡ªæ‘¸å¼¹çª—
            document.getElementById('zimPlayer1').querySelector('.zim-player-name').textContent = players[0].name;
            document.getElementById('zimPlayer2').querySelector('.zim-player-name').textContent = players[1].name;
            document.getElementById('zimPlayer3').querySelector('.zim-player-name').textContent = players[2].name;
            document.getElementById('zimPlayer4').querySelector('.zim-player-name').textContent = players[3].name;
            document.getElementById('zimDouble1').querySelector('.zim-player-name').textContent = players[0].name;
            document.getElementById('zimDouble2').querySelector('.zim-player-name').textContent = players[1].name;
            document.getElementById('zimDouble3').querySelector('.zim-player-name').textContent = players[2].name;
            document.getElementById('zimDouble4').querySelector('.zim-player-name').textContent = players[3].name;
            // ä¿å­˜å¹¶æ›´æ–°æ˜¾ç¤º
            localStorage.setItem('mahjongPlayers', JSON.stringify(players));
            calcSettleList();
            updateHistoryDisplay();
        }
        function updatePlayerDisplay() {
            document.getElementById('player1').value = players[0].name;
            document.getElementById('player2').value = players[1].name;
            document.getElementById('player3').value = players[2].name;
            document.getElementById('player4').value = players[3].name;
            document.getElementById('total1').textContent = players[0].total + ' å…ƒ';
            document.getElementById('total2').textContent = players[1].total + ' å…ƒ';
            document.getElementById('total3').textContent = players[2].total + ' å…ƒ';
            document.getElementById('total4').textContent = players[3].total + ' å…ƒ';
            // åŒæ­¥åç§°
            updatePlayerName();
        }

        // æ ¸å¿ƒä¼˜åŒ–1ï¼šè‡ªå®šä¹‰é‡‘é¢ - èµ¢/è¾“æŒ‰é’®äº¤äº’ï¼ˆç‚¹å‡»å³èšç„¦è¾“å…¥æ¡†ï¼Œè‡ªåŠ¨å¸¦æ­£è´Ÿï¼Œæ— é»˜è®¤0ï¼‰
        function setAmountType(playerId, type) {
            const input = document.getElementById(`custom${playerId}`);
            const winBtn = input.parentElement.querySelector('.win-btn');
            const loseBtn = input.parentElement.querySelector('.lose-btn');
            // é‡ç½®æŒ‰é’®æ ·å¼
            winBtn.classList.remove('btn-active');
            loseBtn.classList.remove('btn-active');
            // è®¾ç½®ç±»å‹å¹¶é«˜äº®æŒ‰é’®
            input.dataset.type = type;
            type === 'win' ? winBtn.classList.add('btn-active') : loseBtn.classList.add('btn-active');
            // èšç„¦è¾“å…¥æ¡†ï¼Œæ¸…ç©ºåŸæœ‰å†…å®¹ï¼ˆç›´æ¥è¾“å…¥æ•°å­—å³å¯ï¼‰
            input.value = '';
            input.focus();
        }
        // è‡ªå®šä¹‰é‡‘é¢ï¼šæ¸…ç©º
        function clearCustomAmount() {
            for (let i = 1; i <= 4; i++) {
                const input = document.getElementById(`custom${i}`);
                input.value = '';
                input.dataset.type = 'none';
                const winBtn = input.parentElement.querySelector('.win-btn');
                const loseBtn = input.parentElement.querySelector('.lose-btn');
                winBtn.classList.remove('btn-active');
                loseBtn.classList.remove('btn-active');
            }
        }
        // è‡ªå®šä¹‰é‡‘é¢ï¼šè®°å½•æœ¬å±€
        function addCustomRound() {
            const roundData = [];
            let total = 0;
            for (let i = 1; i <= 4; i++) {
                const input = document.getElementById(`custom${i}`);
                const amountVal = Number(input.value) || 0;
                const type = input.dataset.type;
                // æ ¹æ®ç±»å‹è®¡ç®—æœ€ç»ˆé‡‘é¢
                let finalAmount = 0;
                if (type === 'win') finalAmount = Math.abs(amountVal);
                else if (type === 'lose') finalAmount = -Math.abs(amountVal);
                else finalAmount = 0;
                roundData.push({ id: i, amount: finalAmount });
                total += finalAmount;
            }
            // æ ¡éªŒæ”¶æ”¯å¹³è¡¡
            if (total !== 0) {
                alert('æœ¬å±€æ”¶æ”¯ä¸å¹³è¡¡ï¼\nèµ¢çš„é’±è¦ç­‰äºè¾“çš„é’±');
                return;
            }
            // è®°å½•æ•°æ®
            addRoundRecord(roundData);
            hideCustomInput();
            clearCustomAmount();
        }

        // æ ¸å¿ƒä¼˜åŒ–2ï¼šè‡ªæ‘¸åŠŸèƒ½ - é€‰æ‹©è‡ªæ‘¸ç©å®¶+åŒå€æ”¯ä»˜å¼€å…³
        function showZimModal() {
            document.getElementById('zimModal').style.display = 'flex';
            // é‡ç½®è‡ªæ‘¸å’ŒåŒå€çŠ¶æ€
            selectedZimPlayerId = null;
            zimDoubleMap = { 1: false, 2: false, 3: false, 4: false };
            document.querySelectorAll('.zim-player-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.btn-double').forEach(btn => {
                btn.classList.remove('btn-active');
                btn.textContent = 'æ˜¯å¦åŒå€';
            });
            document.getElementById('zimDoubleContainer').style.display = 'none';
            document.getElementById('zimAmount').value = 10;
        }
        function hideZimModal() {
            document.getElementById('zimModal').style.display = 'none';
        }
        // é€‰æ‹©è‡ªæ‘¸ç©å®¶
        function selectZimPlayer(id) {
            selectedZimPlayerId = id;
            // é‡ç½®è‡ªæ‘¸ç©å®¶æ ·å¼
            document.querySelectorAll('.zim-player-item').forEach(item => item.classList.remove('active'));
            document.getElementById(`zimPlayer${id}`).classList.add('active');
            // æ˜¾ç¤ºåŒå€æ”¯ä»˜è®¾ç½®å®¹å™¨ï¼Œéšè—è‡ªæ‘¸ç©å®¶çš„åŒå€æŒ‰é’®
            document.getElementById('zimDoubleContainer').style.display = 'block';
            for (let i = 1; i <= 4; i++) {
                const doubleItem = document.getElementById(`zimDouble${i}`);
                doubleItem.style.display = i === id ? 'none' : 'flex';
            }
        }
        // åˆ‡æ¢éè‡ªæ‘¸ç©å®¶åŒå€æ”¯ä»˜
        function toggleZimDouble(id) {
            zimDoubleMap[id] = !zimDoubleMap[id];
            const btn = document.getElementById(`doubleBtn${id}`);
            if (zimDoubleMap[id]) {
                btn.classList.add('btn-active');
                btn.textContent = 'åŒå€âœ“';
            } else {
                btn.classList.remove('btn-active');
                btn.textContent = 'æ˜¯å¦åŒå€';
            }
        }
        // è‡ªæ‘¸ï¼šç¡®è®¤è®°å½•
        function confirmZim() {
            if (!selectedZimPlayerId) {
                alert('è¯·å…ˆé€‰æ‹©è‡ªæ‘¸çš„ç©å®¶ï¼');
                return;
            }
            const baseAmount = Number(document.getElementById('zimAmount').value) || 0;
            if (baseAmount <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„åŸºç¡€é‡‘é¢ï¼ˆå¤§äº0ï¼‰ï¼');
                return;
            }
            // æ„å»ºè‡ªæ‘¸æ•°æ®ï¼šè‡ªæ‘¸ç©å®¶èµ¢ï¼Œå…¶ä»–ç©å®¶æŒ‰åŒå€/åŸºç¡€æ”¯ä»˜
            const roundData = [];
            let zimWinTotal = 0;
            for (let i = 1; i <= 4; i++) {
                if (i === selectedZimPlayerId) {
                    roundData.push({ id: i, amount: 0 }); // å…ˆå ä½ï¼Œæœ€åè®¡ç®—æ€»èµ¢é¢
                } else {
                    const payAmount = zimDoubleMap[i] ? baseAmount * 2 : baseAmount;
                    roundData.push({ id: i, amount: -payAmount });
                    zimWinTotal += payAmount;
                }
            }
            // è®¾ç½®è‡ªæ‘¸ç©å®¶çš„èµ¢é¢
            roundData[selectedZimPlayerId - 1].amount = zimWinTotal;
            // è®°å½•æ•°æ®
            addRoundRecord(roundData);
            hideZimModal();
        }

        // æ ¸å¿ƒä¼˜åŒ–3ï¼šå†å²è®°å½• - è¡¨æ ¼å½¢å¼å±•ç¤ºï¼ˆæ¨ªå‘ç©å®¶ï¼Œçºµå‘å±€æ•°ï¼‰
        function updateHistoryDisplay() {
            const historyList = document.getElementById('historyList');
            if (historyRecords.length === 0) {
                historyList.innerHTML = '<div class="history-empty">æš‚æ— å¯¹å±€è®°å½•ï½</div>';
                return;
            }
            // æ„å»ºè¡¨æ ¼ï¼šè¡¨å¤´=ç©å®¶åç§°ï¼Œè¡¨ä½“=æ¯å±€ç»“æœ
            let tableHtml = `
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>å±€æ•°/æ—¶é—´</th>
                            <th>${players[0].name}</th>
                            <th>${players[1].name}</th>
                            <th>${players[2].name}</th>
                            <th>${players[3].name}</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            // å€’åºæ˜¾ç¤ºï¼ˆæœ€æ–°å±€åœ¨æœ€ä¸Šï¼‰
            historyRecords.reverse().forEach((record, index) => {
                const gameNo = historyRecords.length - index;
                const timeStr = record.time.split(' ')[1]; // åªæ˜¾ç¤ºæ—¶åˆ†ç§’ï¼ŒèŠ‚çœå®½åº¦
                tableHtml += `<tr><td>ç¬¬${gameNo}å±€<br>${timeStr}</td>`;
                // éå†æ¯ä¸ªç©å®¶çš„æœ¬å±€ç»“æœ
                record.details.forEach(item => {
                    let numClass = 'zero-num';
                    let amountText = item.amount;
                    if (item.amount > 0) {
                        numClass = 'win-num';
                        amountText = `+${item.amount}`;
                    } else if (item.amount < 0) {
                        numClass = 'lose-num';
                    }
                    tableHtml += `<td class="${numClass}">${amountText}</td>`;
                });
                tableHtml += `</tr>`;
            });
            historyRecords.reverse();
            tableHtml += `
                    </tbody>
                </table>
            `;
            historyList.innerHTML = tableHtml;
        }

        // é€šç”¨è®°å½•å•å±€ç»“æœæ–¹æ³•
        function addRoundRecord(roundData) {
            // æ›´æ–°ç©å®¶æ€»é‡‘é¢
            roundData.forEach(item => {
                const player = players.find(p => p.id === item.id);
                if (player) player.total += Number(item.amount);
            });
            // æ·»åŠ å†å²è®°å½•
            const now = new Date();
            const timeStr = formatTime(now);
            historyRecords.push({
                time: timeStr,
                details: JSON.parse(JSON.stringify(roundData))
            });
            // æœ¬åœ°ä¿å­˜
            localStorage.setItem('mahjongPlayers', JSON.stringify(players));
            localStorage.setItem('mahjongHistory', JSON.stringify(historyRecords));
            // æ›´æ–°æ‰€æœ‰æ˜¾ç¤º
            updatePlayerDisplay();
            calcSettleList();
            updateHistoryDisplay();
            alert('è®°å½•æˆåŠŸï¼');
        }

        // ç»“ç®—æ¸…å•è®¡ç®—
        function calcSettleList() {
            const settleList = document.getElementById('settleList');
            const tempPlayers = JSON.parse(JSON.stringify(players));
            let html = '';
            const creditors = tempPlayers.filter(p => p.total > 0).sort((a, b) => b.total - a.total);
            const debtors = tempPlayers.filter(p => p.total < 0).sort((a, b) => a.total - b.total);
            if (creditors.length === 0 && debtors.length === 0) {
                html = '<div class="empty-tip">æš‚æ— è®°å½•ï¼Œå…ˆæ·»åŠ å¯¹å±€ç»“æœå§ï½</div>';
            } else {
                debtors.forEach(debtor => {
                    let debt = Math.abs(debtor.total);
                    if (debt <= 0) return;
                    creditors.forEach(creditor => {
                        if (debt <= 0 || creditor.total <= 0) return;
                        const payAmount = Math.min(debt, creditor.total);
                        html += `<div class="settle-item">${debtor.name} â†’ ${creditor.name}ï¼š${payAmount} å…ƒ</div>`;
                        debt -= payAmount;
                        creditor.total -= payAmount;
                        debtor.total += payAmount;
                    });
                });
                if (html === '') html = '<div class="empty-tip">æš‚æ— è½¬è´¦ï¼Œæ‰€æœ‰äººæ”¶æ”¯å¹³è¡¡ï½</div>';
            }
            settleList.innerHTML = html;
        }

        // æ˜¾ç¤º/éšè—è‡ªå®šä¹‰æ¨¡å—
        function showCustomInput() {
            document.getElementById('customModule').style.display = 'block';
            clearCustomAmount();
        }
        function hideCustomInput() {
            document.getElementById('customModule').style.display = 'none';
        }

        // æ¸…ç©ºæ‰€æœ‰è®°å½•/ä»…æ¸…ç©ºå†å²
        function clearAll() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è®°å½•ï¼ˆåŒ…æ‹¬å†å²ã€æ€»æ”¶æ”¯ã€è®¡æ—¶ï¼‰å—ï¼Ÿ')) {
                players = [{ id:1,name:'A',total:0 },{ id:2,name:'B',total:0 },{ id:3,name:'C',total:0 },{ id:4,name:'D',total:0 }];
                historyRecords = [];
                clearInterval(timerInterval);
                isTiming = false;
                elapsedSeconds = 0;
                document.getElementById('startTime').textContent = 'å¼€å§‹æ—¶é—´ï¼šæœªå¼€å§‹';
                document.getElementById('timer').textContent = 'è®¡æ—¶ï¼š00:00:00';
                document.getElementById('timerBtn').textContent = 'å¼€å§‹è®¡æ—¶';
                document.getElementById('timerBtn').classList.remove('stop');
                localStorage.clear();
                updatePlayerDisplay();
                calcSettleList();
                updateHistoryDisplay();
                alert('å·²æ¸…ç©ºæ‰€æœ‰è®°å½•ï¼');
            }
        }
        function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¯¹å±€å†å²è®°å½•å—ï¼Ÿæ€»æ”¶æ”¯ä¸ä¼šæ”¹å˜')) {
                historyRecords = [];
                localStorage.setItem('mahjongHistory', JSON.stringify(historyRecords));
                updateHistoryDisplay();
                alert('å·²æ¸…ç©ºå†å²è®°å½•ï¼');
            }
        }
    </script>
</body>
</html>